---
version: "3"

tasks:

  bootstrap:
    desc: Load flux into cluster
    cmds:
      - cmd: kubectl --kubeconfig={{.PROJECT_DIR}}/provision/kubeconfig create namespace flux-system
      - cmd: cat ~/.config/sops/age/keys.txt | kubectl --kubeconfig={{.PROJECT_DIR}}/provision/kubeconfig -n flux-system create secret generic sops-age --from-file=age.agekey=/dev/stdin
      - cmd: kubectl --kubeconfig={{.PROJECT_DIR}}/provision/kubeconfig apply --kustomize={{.PROJECT_DIR}}/cluster/base/flux-system
        ignore_error: true
      - kubectl --kubeconfig={{.PROJECT_DIR}}/provision/kubeconfig apply --kustomize={{.PROJECT_DIR}}/cluster/base/flux-system


  sync:
    desc: Sync flux-system with the Git Repository
    cmds:
      - flux reconcile source git flux-system
    silent: true

